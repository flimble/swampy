require 'albacore'

root_path = File.dirname(__FILE__)
@build_logger = ENV['env_buildlogger']


desc "Builds solution, runs Unit Tests"
task :default => [:install_nuget_packages, :build, :unit]

desc "Build the solution in .Net 4.0"
msbuild :build do |msb|
	msb.properties :configuration => :Debug
	msb.targets :Clean, :Build
	msb.verbosity = 'quiet'
	msb.solution = File.join(root_path, "Swampy.sln")
	if !@build_logger.nil?
		msb.loggermodule = @build_logger
	end
end

desc "Build the solution in .Net 4.0 release mode"
msbuild :release_build do |msb|
	msb.properties :configuration => :Release
	msb.targets :Clean, :Build
	msb.verbosity = 'quiet'
	msb.solution = File.join(root_path, "Swampy.sln")
	if !@build_logger.nil?
		msb.loggermodule = @build_logger
	end
end

desc "Run Unit tests"
nunit :unit do |nunit|
	nunit.command = "packages/NUnit.Runners.2.6.2/tools/nunit-console-x86.exe"
	nunit.assemblies "UnitTest/bin/Debug/Swampy.UnitTest.dll"
	nunit.options '/xml=Results.UnitTest-results.xml'
end

desc "Run Integration tests"
nunit :integration do |nunit|
	nunit.command = "packages/NUnit.Runners.2.6.2/tools/nunit-console-x86.exe"
	nunit.assemblies "IntegrationTest/bin/Debug/Swampy.IntegrationTest.dll"
	nunit.options '/xml=Results.IntegrationTest-results.xml'
end

task :install_nuget_packages do 
  root_path  = File.dirname(__FILE__)
  packagesdir = File.join(root_path, 'packages')

  #install global packages
  if File.exist?('.nuget/packages.config') 
	sh ".nuget/NuGet.exe install .nuget/packages.config -o #{packagesdir}"
  end
  
  #install all other packages
  FileList["**/packages.config"].each { |filepath|	
    sh ".nuget/NuGet.exe install #{filepath} -o #{packagesdir}"
  }
end